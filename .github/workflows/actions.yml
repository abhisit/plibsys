name: plibsys-ci
on: [push]
jobs:
  main:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            CC: gcc
            CXX: g++
          - os: ubuntu-latest
            CC: clang
            CXX: clang++
          - os: macos-latest
            CC: clang
            CXX: clang++
          - os: macos-latest
            CC: gcc-12
            CXX: g++-12
    steps:
      - uses: actions/checkout@v3
      - name: config
        run: |
          pwd
          cd ..
          mkdir ./plibsys-build
          cd ./plibsys-build
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=${{ matrix.CC }} -DCMAKE_CXX_COMPILER=${{ matrix.CXX }} -DPLIBSYS_COVERAGE=ON ../plibsys
      - name: build
        run: |
          pwd
          cd ../plibsys-build
          make -j
      - name: test
        run: |
          pwd
          cd ../plibsys-build
          ctest
      - name: lcov
        if: ${{ success() && matrix.os == 'ubuntu-latest' && matrix.CC == 'gcc' }}
        run: |
          pwd
          sudo apt-get update
          sudo apt-get install lcov
          cd ../plibsys-build
          lcov -c --directory . --no-external --base-directory ../plibsys --output-file ./coverage.info
      - name: coverage
        if: ${{ success() && matrix.os == 'ubuntu-latest' && matrix.CC == 'gcc' }}
        uses: codecov/codecov-action@v4-beta
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          working-directory: ../plibsys-build
          root_dir: ../plibsys
          gcov: false
